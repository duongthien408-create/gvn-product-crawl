<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CellphoneS Crawler - Product Data Extraction</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563EB',
                        secondary: '#3B82F6',
                        accent: '#F97316',
                        dark: {
                            900: '#0F172A',
                            800: '#1E293B',
                            700: '#334155',
                            600: '#475569',
                        }
                    },
                    fontFamily: {
                        heading: ['Space Grotesk', 'sans-serif'],
                        body: ['DM Sans', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'DM Sans', sans-serif;
            background: linear-gradient(135deg, #0F172A 0%, #1E293B 50%, #0F172A 100%);
            min-height: 100vh;
        }
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .glass-light {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid #F97316;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .gradient-text {
            background: linear-gradient(135deg, #3B82F6 0%, #F97316 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .glow {
            box-shadow: 0 0 30px rgba(37, 99, 235, 0.3);
        }
        .card-hover {
            transition: all 0.3s ease-out;
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        @media (prefers-reduced-motion: reduce) {
            .card-hover:hover {
                transform: none;
            }
            .loader {
                animation: none;
            }
        }
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.3);
        }
    </style>
</head>
<body class="text-gray-100">
    <!-- Floating Header -->
    <header class="fixed top-4 left-4 right-4 z-50">
        <nav class="glass rounded-2xl px-6 py-4 max-w-7xl mx-auto">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-primary to-accent flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="font-heading font-bold text-xl text-white">CellphoneS Crawler</h1>
                        <p class="text-xs text-gray-400">Product Data Extraction Tool</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <span class="hidden sm:flex items-center gap-2 text-sm text-gray-400">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                        Server Online
                    </span>
                </div>
            </div>
        </nav>
    </header>

    <main class="pt-28 pb-12 px-4">
        <div class="max-w-7xl mx-auto">
            <!-- Hero Section -->
            <div class="text-center mb-12">
                <h2 class="font-heading text-4xl md:text-5xl font-bold mb-4">
                    <span class="gradient-text">Extract Product Data</span>
                </h2>
                <p class="text-gray-400 text-lg max-w-2xl mx-auto">
                    Crawl product specifications from CellphoneS with full technical details, pricing, and images.
                </p>
            </div>

            <!-- Input Section -->
            <div class="glass rounded-3xl p-6 md:p-8 mb-8 glow">
                <!-- Tabs -->
                <div class="flex gap-2 mb-6 p-1 glass-light rounded-xl w-fit">
                    <button onclick="switchTab('single')" id="tabSingle" class="px-5 py-2.5 rounded-lg font-medium transition-all duration-200 bg-primary text-white cursor-pointer">
                        Single URL
                    </button>
                    <button onclick="switchTab('bulk')" id="tabBulk" class="px-5 py-2.5 rounded-lg font-medium transition-all duration-200 text-gray-400 hover:text-white cursor-pointer">
                        Bulk URLs
                    </button>
                    <button onclick="switchTab('csv')" id="tabCsv" class="px-5 py-2.5 rounded-lg font-medium transition-all duration-200 text-gray-400 hover:text-white cursor-pointer">
                        Import CSV
                    </button>
                </div>

                <!-- Single URL Input -->
                <div id="singleInput">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <div class="flex-1 relative">
                            <input
                                type="text"
                                id="productUrl"
                                placeholder="https://cellphones.com.vn/product-name.html"
                                class="w-full px-5 py-4 bg-dark-800 border border-dark-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all"
                            >
                            <div class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                                </svg>
                            </div>
                        </div>
                        <button
                            id="crawlBtn"
                            onclick="crawlProduct()"
                            class="px-8 py-4 bg-gradient-to-r from-primary to-secondary text-white font-semibold rounded-xl hover:opacity-90 transition-all flex items-center justify-center gap-2 cursor-pointer"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                            </svg>
                            <span>Extract</span>
                            <div id="loader" class="loader hidden"></div>
                        </button>
                    </div>
                </div>

                <!-- Bulk URL Input -->
                <div id="bulkInput" class="hidden">
                    <textarea
                        id="bulkUrls"
                        rows="5"
                        placeholder="Paste multiple URLs, one per line:&#10;https://cellphones.com.vn/product-1.html&#10;https://cellphones.com.vn/product-2.html"
                        class="w-full px-5 py-4 bg-dark-800 border border-dark-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all font-mono text-sm resize-none"
                    ></textarea>
                    <div class="flex justify-between items-center mt-4">
                        <span id="urlCount" class="text-gray-500 text-sm">0 valid URLs</span>
                        <button
                            id="bulkCrawlBtn"
                            onclick="crawlBulk()"
                            class="px-6 py-3 bg-gradient-to-r from-primary to-secondary text-white font-semibold rounded-xl hover:opacity-90 transition-all flex items-center gap-2 cursor-pointer"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            <span>Extract All</span>
                            <div id="bulkLoader" class="loader hidden"></div>
                        </button>
                    </div>
                    <div id="bulkProgress" class="hidden mt-4">
                        <div class="flex justify-between text-sm text-gray-400 mb-2">
                            <span>Processing: <span id="progressText" class="text-white">0/0</span></span>
                            <span id="progressPercent" class="text-accent">0%</span>
                        </div>
                        <div class="w-full bg-dark-700 rounded-full h-2 overflow-hidden">
                            <div id="progressBar" class="bg-gradient-to-r from-primary to-accent h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <div id="progressLog" class="mt-3 max-h-40 overflow-y-auto text-sm font-mono bg-dark-800 rounded-xl p-4"></div>
                    </div>
                </div>

                <!-- CSV File Input -->
                <div id="csvInput" class="hidden">
                    <div class="border-2 border-dashed border-dark-600 rounded-2xl p-8 text-center hover:border-primary/50 transition-colors">
                        <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-dark-700 flex items-center justify-center">
                            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                        </div>
                        <p class="text-gray-400 mb-4">Upload CSV file with product URLs</p>
                        <input type="file" id="csvFile" accept=".csv" onchange="previewCSV(this)" class="hidden">
                        <div class="flex justify-center gap-3">
                            <button onclick="document.getElementById('csvFile').click()" class="px-6 py-3 bg-dark-700 text-white font-medium rounded-xl hover:bg-dark-600 transition-colors cursor-pointer">
                                Choose File
                            </button>
                            <button onclick="downloadTemplate()" class="px-6 py-3 bg-primary/20 text-primary font-medium rounded-xl hover:bg-primary/30 transition-colors flex items-center gap-2 cursor-pointer">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                                Download Template
                            </button>
                        </div>
                    </div>
                    <div id="csvPreview" class="hidden mt-4">
                        <div class="flex justify-between items-center mb-3">
                            <span class="font-medium text-white">File: <span id="csvFileName" class="text-gray-400"></span></span>
                            <span id="csvUrlCount" class="text-sm px-3 py-1 bg-primary/20 text-primary rounded-full">0 URLs</span>
                        </div>
                        <div class="mb-3">
                            <label class="block text-sm text-gray-400 mb-2">Select URL column:</label>
                            <select id="csvColumnSelect" onchange="updateCsvUrls()" class="px-4 py-2.5 bg-dark-800 border border-dark-600 rounded-xl text-white focus:outline-none focus:border-primary cursor-pointer"></select>
                        </div>
                        <div id="csvUrlPreview" class="max-h-32 overflow-y-auto bg-dark-800 rounded-xl p-4 font-mono text-sm text-gray-400 mb-4"></div>
                        <button id="csvCrawlBtn" onclick="crawlFromCSV()" class="w-full px-6 py-3 bg-gradient-to-r from-primary to-secondary text-white font-semibold rounded-xl hover:opacity-90 transition-all flex items-center justify-center gap-2 cursor-pointer">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            <span>Extract All from CSV</span>
                            <div id="csvLoader" class="loader hidden"></div>
                        </button>
                    </div>
                    <div id="csvProgress" class="hidden mt-4">
                        <div class="flex justify-between text-sm text-gray-400 mb-2">
                            <span>Processing: <span id="csvProgressText" class="text-white">0/0</span></span>
                            <span id="csvProgressPercent" class="text-accent">0%</span>
                        </div>
                        <div class="w-full bg-dark-700 rounded-full h-2 overflow-hidden">
                            <div id="csvProgressBar" class="bg-gradient-to-r from-primary to-accent h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <div id="csvProgressLog" class="mt-3 max-h-40 overflow-y-auto text-sm font-mono bg-dark-800 rounded-xl p-4"></div>
                    </div>
                </div>

                <p id="errorMsg" class="text-red-400 mt-4 hidden"></p>
            </div>

            <!-- Result Section -->
            <div id="resultSection" class="hidden mb-8">
                <div class="glass rounded-3xl overflow-hidden">
                    <div class="p-6 md:p-8">
                        <div class="flex flex-col lg:flex-row gap-8">
                            <div class="lg:w-1/3">
                                <div class="glass-light rounded-2xl p-4">
                                    <img id="productImage" src="" alt="" class="w-full h-64 object-contain">
                                </div>
                            </div>
                            <div class="lg:w-2/3">
                                <h3 id="productName" class="font-heading text-2xl md:text-3xl font-bold text-white mb-2"></h3>
                                <p id="productBrand" class="text-gray-400 mb-6"></p>
                                <div class="flex flex-wrap items-center gap-4 mb-6">
                                    <span id="productPrice" class="text-3xl font-bold text-accent"></span>
                                    <span id="productOriginalPrice" class="text-xl text-gray-500 line-through"></span>
                                    <span id="productDiscount" class="px-3 py-1 bg-accent/20 text-accent rounded-full text-sm font-semibold"></span>
                                </div>
                                <a id="productLink" href="" target="_blank" class="inline-flex items-center gap-2 text-primary hover:text-secondary transition-colors cursor-pointer">
                                    <span>View on CellphoneS</span>
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                    </svg>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="border-t border-dark-700 p-6 md:p-8">
                        <h4 class="font-heading text-xl font-semibold mb-6 flex items-center gap-2">
                            <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                            Technical Specifications
                        </h4>
                        <div class="overflow-x-auto">
                            <table class="w-full"><tbody id="specsTable"></tbody></table>
                        </div>
                    </div>
                    <div class="border-t border-dark-700 p-6 flex flex-wrap gap-3">
                        <button onclick="copySpecs()" class="px-5 py-2.5 bg-dark-700 text-white rounded-xl hover:bg-dark-600 transition-colors flex items-center gap-2 cursor-pointer">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                            Copy Specs
                        </button>
                        <button onclick="downloadJSON()" class="px-5 py-2.5 bg-dark-700 text-white rounded-xl hover:bg-dark-600 transition-colors flex items-center gap-2 cursor-pointer">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            JSON
                        </button>
                        <button onclick="downloadCSV()" class="px-5 py-2.5 bg-primary text-white rounded-xl hover:bg-primary/80 transition-colors flex items-center gap-2 cursor-pointer">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            CSV
                        </button>
                    </div>
                </div>
            </div>

            <!-- Saved Products Section -->
            <div class="glass rounded-3xl p-6 md:p-8">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                    <div class="flex items-center gap-4">
                        <h2 class="font-heading text-xl font-semibold flex items-center gap-2">
                            <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
                            </svg>
                            Saved Products
                        </h2>
                        <label class="flex items-center gap-2 text-sm text-gray-400 cursor-pointer">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" class="w-4 h-4 rounded bg-dark-700 border-dark-600 text-primary focus:ring-primary cursor-pointer">
                            Select all
                        </label>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="exportSelectedCSV()" id="exportSelectedBtn" class="hidden px-4 py-2 bg-accent text-white rounded-xl hover:bg-accent/80 transition-colors text-sm flex items-center gap-2 cursor-pointer">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            Export Selected (<span id="selectedCount">0</span>)
                        </button>
                        <button onclick="exportAllCSV()" class="px-4 py-2 bg-primary text-white rounded-xl hover:bg-primary/80 transition-colors text-sm flex items-center gap-2 cursor-pointer">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            Export All
                        </button>
                        <button onclick="loadProducts()" class="px-4 py-2 bg-dark-700 text-white rounded-xl hover:bg-dark-600 transition-colors text-sm flex items-center gap-2 cursor-pointer">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Refresh
                        </button>
                    </div>
                </div>
                <div id="productsList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
                <p id="noProducts" class="text-gray-500 text-center py-12 hidden">No products saved yet</p>
            </div>
        </div>
    </main>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 right-6 px-6 py-3 bg-green-500 text-white rounded-xl shadow-2xl transform translate-y-full opacity-0 transition-all duration-300 flex items-center gap-2 z-50">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span id="toastMsg">Success!</span>
    </div>

    <script>
        let currentProduct = null;
        let allProducts = [];

        function switchTab(tab) {
            const tabs = ['single', 'bulk', 'csv'];
            tabs.forEach(t => {
                const input = document.getElementById(t + 'Input');
                const btn = document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1));
                if (t === tab) {
                    input.classList.remove('hidden');
                    btn.classList.add('bg-primary', 'text-white');
                    btn.classList.remove('text-gray-400');
                } else {
                    input.classList.add('hidden');
                    btn.classList.remove('bg-primary', 'text-white');
                    btn.classList.add('text-gray-400');
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const bulkUrls = document.getElementById('bulkUrls');
            if (bulkUrls) {
                bulkUrls.addEventListener('input', function() {
                    const urls = this.value.split('\n').filter(url => url.trim() && url.includes('cellphones.com.vn'));
                    document.getElementById('urlCount').textContent = `${urls.length} valid URLs`;
                });
            }
        });

        async function crawlBulk() {
            const textarea = document.getElementById('bulkUrls');
            const urls = textarea.value.split('\n').map(url => url.trim()).filter(url => url && url.includes('cellphones.com.vn'));
            if (urls.length === 0) { showError('Please enter at least 1 valid CellphoneS URL'); return; }
            const btn = document.getElementById('bulkCrawlBtn');
            const loader = document.getElementById('bulkLoader');
            const progress = document.getElementById('bulkProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const progressPercent = document.getElementById('progressPercent');
            const progressLog = document.getElementById('progressLog');

            btn.disabled = true;
            loader.classList.remove('hidden');
            progress.classList.remove('hidden');
            progressLog.innerHTML = '';

            let success = 0, failed = 0;
            for (let i = 0; i < urls.length; i++) {
                const url = urls[i];
                const current = i + 1;
                const percent = Math.round((current / urls.length) * 100);
                progressText.textContent = `${current}/${urls.length}`;
                progressPercent.textContent = `${percent}%`;
                progressBar.style.width = `${percent}%`;

                const logEntry = document.createElement('div');
                logEntry.className = 'text-gray-400 py-1';
                logEntry.innerHTML = `<span class="text-primary">[${current}/${urls.length}]</span> Extracting: ${url.split('/').pop()}...`;
                progressLog.appendChild(logEntry);
                progressLog.scrollTop = progressLog.scrollHeight;

                try {
                    const response = await fetch('/api/crawl', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url }) });
                    const data = await response.json();
                    if (data.success) { success++; logEntry.innerHTML = `<span class="text-green-400">[${current}/${urls.length}]</span> ${data.product.name.substring(0, 40)}...`; }
                    else { failed++; logEntry.innerHTML = `<span class="text-red-400">[${current}/${urls.length}]</span> Error: ${data.error}`; }
                } catch (error) { failed++; logEntry.innerHTML = `<span class="text-red-400">[${current}/${urls.length}]</span> Connection error`; }
            }

            btn.disabled = false;
            loader.classList.add('hidden');
            const summary = document.createElement('div');
            summary.className = 'mt-3 pt-3 border-t border-dark-700 font-semibold';
            summary.innerHTML = `<span class="text-green-400">Success: ${success}</span> | <span class="text-red-400">Failed: ${failed}</span>`;
            progressLog.appendChild(summary);
            loadProducts();
            showToast(`Extracted ${success}/${urls.length} products!`);
        }

        async function crawlProduct() {
            const url = document.getElementById('productUrl').value.trim();
            const loader = document.getElementById('loader');
            const btn = document.getElementById('crawlBtn');
            if (!url) { showError('Please enter a product URL'); return; }
            if (!url.includes('cellphones.com.vn')) { showError('URL must be from cellphones.com.vn'); return; }

            loader.classList.remove('hidden');
            btn.disabled = true;
            document.getElementById('errorMsg').classList.add('hidden');

            try {
                const response = await fetch('/api/crawl', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url }) });
                const data = await response.json();
                if (data.success) { currentProduct = data.product; displayProduct(data.product); loadProducts(); }
                else { showError(data.error || 'An error occurred'); }
            } catch (error) { showError('Cannot connect to server'); }
            finally { loader.classList.add('hidden'); btn.disabled = false; }
        }

        function displayProduct(product) {
            document.getElementById('resultSection').classList.remove('hidden');
            document.getElementById('productImage').src = product.image;
            document.getElementById('productName').textContent = product.name;
            document.getElementById('productBrand').textContent = product.brand ? `Brand: ${product.brand}` : '';
            document.getElementById('productPrice').textContent = formatPrice(product.price);
            document.getElementById('productOriginalPrice').textContent = formatPrice(product.original_price);
            document.getElementById('productDiscount').textContent = product.discount || '';
            document.getElementById('productLink').href = product.url;

            if (!product.discount) { document.getElementById('productDiscount').classList.add('hidden'); document.getElementById('productOriginalPrice').classList.add('hidden'); }
            else { document.getElementById('productDiscount').classList.remove('hidden'); document.getElementById('productOriginalPrice').classList.remove('hidden'); }

            const specsTable = document.getElementById('specsTable');
            specsTable.innerHTML = '';
            let index = 0;
            for (const [key, value] of Object.entries(product.specs || {})) {
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'bg-dark-800/50' : '';
                row.innerHTML = `<td class="px-4 py-3 font-medium text-gray-300 w-1/3">${escapeHtml(key)}</td><td class="px-4 py-3 text-gray-400">${escapeHtml(value)}</td>`;
                specsTable.appendChild(row);
                index++;
            }
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
        }

        async function loadProducts() {
            try {
                const response = await fetch('/api/products');
                const data = await response.json();
                const container = document.getElementById('productsList');
                const noProducts = document.getElementById('noProducts');

                if (data.products.length === 0) { container.innerHTML = ''; noProducts.classList.remove('hidden'); return; }

                noProducts.classList.add('hidden');
                allProducts = data.products;
                container.innerHTML = data.products.map(product => `
                    <div class="glass-light rounded-2xl p-4 card-hover relative cursor-pointer" onclick="viewProduct('${product.sku}')">
                        <input type="checkbox" class="product-checkbox absolute top-3 left-3 w-5 h-5 rounded bg-dark-700 border-dark-600 text-primary focus:ring-primary cursor-pointer z-10" data-sku="${product.sku}" onchange="updateSelectedCount()" onclick="event.stopPropagation()">
                        <img src="${product.image}" alt="" class="w-full h-36 object-contain mb-3">
                        <h4 class="font-medium text-white text-sm line-clamp-2 mb-2 h-10">${escapeHtml(product.name)}</h4>
                        <p class="text-accent font-bold">${formatPrice(product.price)}</p>
                        <div class="mt-3 flex gap-2">
                            <button onclick="event.stopPropagation(); viewProduct('${product.sku}')" class="flex-1 px-3 py-2 bg-dark-700 text-white rounded-lg hover:bg-dark-600 transition-colors text-sm cursor-pointer">View</button>
                            <button onclick="event.stopPropagation(); deleteProduct('${product.sku}')" class="px-3 py-2 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500/30 transition-colors text-sm cursor-pointer">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) { console.error('Error loading products:', error); }
        }

        async function viewProduct(sku) {
            try {
                const response = await fetch(`/api/products/${sku}`);
                const data = await response.json();
                if (data.product) { currentProduct = data.product; displayProduct(data.product); }
            } catch (error) { showError('Cannot load product info'); }
        }

        async function deleteProduct(sku) {
            if (!confirm('Delete this product?')) return;
            try { await fetch(`/api/products/${sku}`, { method: 'DELETE' }); loadProducts(); showToast('Product deleted'); }
            catch (error) { showError('Cannot delete product'); }
        }

        function copySpecs() {
            if (!currentProduct) return;
            let text = `${currentProduct.name}\nPrice: ${formatPrice(currentProduct.price)}\n\nSpecifications:\n`;
            for (const [key, value] of Object.entries(currentProduct.specs || {})) { text += `- ${key}: ${value}\n`; }
            navigator.clipboard.writeText(text).then(() => showToast('Specs copied!'));
        }

        function downloadJSON() {
            if (!currentProduct) return;
            const blob = new Blob([JSON.stringify(currentProduct, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `${currentProduct.sku}.json`; a.click();
            URL.revokeObjectURL(url);
        }

        function downloadCSV() {
            if (!currentProduct) return;
            const rows = [['Info', 'Value'], ['Name', currentProduct.name], ['SKU', currentProduct.sku], ['Brand', currentProduct.brand || ''], ['Price', currentProduct.price], ['Original Price', currentProduct.original_price], ['Discount', currentProduct.discount || ''], ['URL', currentProduct.url], ['Image', currentProduct.image], [''], ['Specifications', '']];
            for (const [key, value] of Object.entries(currentProduct.specs || {})) { rows.push([key, value.replace(/\n/g, ' | ')]); }
            const csvContent = rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\n');
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `${currentProduct.sku}.csv`; a.click();
            URL.revokeObjectURL(url);
            showToast('CSV downloaded!');
        }

        async function exportAllCSV() {
            try {
                const response = await fetch('/api/products');
                const data = await response.json();
                if (!data.products || data.products.length === 0) { showError('No products to export'); return; }
                exportProductsToCSV(data.products, 'cellphones_all');
            } catch (error) { showError('Cannot export CSV'); }
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll').checked;
            document.querySelectorAll('.product-checkbox').forEach(cb => cb.checked = selectAll);
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const checked = document.querySelectorAll('.product-checkbox:checked');
            const count = checked.length;
            document.getElementById('selectedCount').textContent = count;
            const btn = document.getElementById('exportSelectedBtn');
            btn.classList.toggle('hidden', count === 0);
            const total = document.querySelectorAll('.product-checkbox').length;
            document.getElementById('selectAll').checked = (count === total && total > 0);
        }

        function exportSelectedCSV() {
            const checkedSkus = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.dataset.sku);
            if (checkedSkus.length === 0) { showError('Please select at least 1 product'); return; }
            const selectedProducts = allProducts.filter(p => checkedSkus.includes(p.sku));
            exportProductsToCSV(selectedProducts, `cellphones_selected_${selectedProducts.length}`);
        }

        function exportProductsToCSV(products, filename) {
            const allSpecKeys = new Set();
            products.forEach(p => Object.keys(p.specs || {}).forEach(key => allSpecKeys.add(key)));
            const specKeys = Array.from(allSpecKeys);
            const headers = ['#', 'SKU', 'Name', 'Brand', 'Price', 'Original Price', 'Discount', 'URL', 'Image', ...specKeys];
            const rows = [headers];
            products.forEach((product, index) => {
                const row = [index + 1, product.sku, product.name, product.brand || '', product.price, product.original_price, product.discount || '', product.url, product.image];
                specKeys.forEach(key => row.push((product.specs || {})[key]?.replace(/\n/g, ' | ') || ''));
                rows.push(row);
            });
            const csvContent = rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\n');
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `${filename}_${new Date().toISOString().slice(0,10)}.csv`; a.click();
            URL.revokeObjectURL(url);
            showToast(`Exported ${products.length} products!`);
        }

        function downloadTemplate() {
            const template = `STT,URL\n1,https://cellphones.com.vn/iphone-16-pro-max.html\n2,https://cellphones.com.vn/iphone-16-pro.html\n3,https://cellphones.com.vn/samsung-galaxy-s24-ultra.html`;
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + template], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'template_urls.csv'; a.click();
            URL.revokeObjectURL(url);
            showToast('Template downloaded!');
        }

        let csvData = [];
        let csvUrls = [];

        function previewCSV(input) {
            const file = input.files[0];
            if (!file) return;
            document.getElementById('csvFileName').textContent = file.name;
            const reader = new FileReader();
            reader.onload = function(e) {
                csvData = parseCSV(e.target.result);
                if (csvData.length === 0) { showError('CSV file is empty or invalid'); return; }
                const headers = csvData[0];
                const select = document.getElementById('csvColumnSelect');
                select.innerHTML = '';
                let urlColumnIndex = 0;
                headers.forEach((header, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = header || `Column ${index + 1}`;
                    select.appendChild(option);
                    if (header.toLowerCase().includes('url') || header.toLowerCase().includes('link')) urlColumnIndex = index;
                });
                select.value = urlColumnIndex;
                document.getElementById('csvPreview').classList.remove('hidden');
                updateCsvUrls();
            };
            reader.readAsText(file);
        }

        function parseCSV(text) {
            const lines = text.split(/\r?\n/);
            const result = [];
            for (const line of lines) {
                if (!line.trim()) continue;
                const row = [];
                let cell = '', inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') { if (inQuotes && line[i + 1] === '"') { cell += '"'; i++; } else inQuotes = !inQuotes; }
                    else if (char === ',' && !inQuotes) { row.push(cell.trim()); cell = ''; }
                    else cell += char;
                }
                row.push(cell.trim());
                result.push(row);
            }
            return result;
        }

        function updateCsvUrls() {
            const columnIndex = parseInt(document.getElementById('csvColumnSelect').value);
            const preview = document.getElementById('csvUrlPreview');
            csvUrls = [];
            preview.innerHTML = '';
            for (let i = 1; i < csvData.length; i++) {
                const url = csvData[i][columnIndex];
                if (url && url.includes('cellphones.com.vn')) {
                    csvUrls.push(url);
                    const div = document.createElement('div');
                    div.className = 'truncate py-1';
                    div.textContent = url;
                    preview.appendChild(div);
                }
            }
            document.getElementById('csvUrlCount').textContent = `${csvUrls.length} URLs`;
        }

        async function crawlFromCSV() {
            if (csvUrls.length === 0) { showError('No valid URLs found in CSV'); return; }
            const btn = document.getElementById('csvCrawlBtn');
            const loader = document.getElementById('csvLoader');
            const progress = document.getElementById('csvProgress');
            const progressBar = document.getElementById('csvProgressBar');
            const progressText = document.getElementById('csvProgressText');
            const progressPercent = document.getElementById('csvProgressPercent');
            const progressLog = document.getElementById('csvProgressLog');

            btn.disabled = true;
            loader.classList.remove('hidden');
            progress.classList.remove('hidden');
            progressLog.innerHTML = '';

            let success = 0, failed = 0;
            for (let i = 0; i < csvUrls.length; i++) {
                const url = csvUrls[i];
                const current = i + 1;
                const percent = Math.round((current / csvUrls.length) * 100);
                progressText.textContent = `${current}/${csvUrls.length}`;
                progressPercent.textContent = `${percent}%`;
                progressBar.style.width = `${percent}%`;

                const logEntry = document.createElement('div');
                logEntry.className = 'text-gray-400 py-1';
                logEntry.innerHTML = `<span class="text-primary">[${current}/${csvUrls.length}]</span> ${url.split('/').pop()}...`;
                progressLog.appendChild(logEntry);
                progressLog.scrollTop = progressLog.scrollHeight;

                try {
                    const response = await fetch('/api/crawl', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url }) });
                    const data = await response.json();
                    if (data.success) { success++; logEntry.innerHTML = `<span class="text-green-400">[${current}/${csvUrls.length}]</span> ${data.product.name.substring(0, 40)}...`; }
                    else { failed++; logEntry.innerHTML = `<span class="text-red-400">[${current}/${csvUrls.length}]</span> ${data.error}`; }
                } catch (error) { failed++; logEntry.innerHTML = `<span class="text-red-400">[${current}/${csvUrls.length}]</span> Connection error`; }
            }

            btn.disabled = false;
            loader.classList.add('hidden');

            lastCrawledSkus = [];

            const summary = document.createElement('div');
            summary.className = 'mt-3 pt-3 border-t border-dark-700 font-semibold';
            summary.innerHTML = `<span class="text-green-400">Success: ${success}</span> | <span class="text-red-400">Failed: ${failed}</span>`;
            progressLog.appendChild(summary);

            if (success > 0) {
                const completionDiv = document.createElement('div');
                completionDiv.className = 'mt-4 p-4 bg-green-500/10 border border-green-500/30 rounded-xl';
                completionDiv.innerHTML = `
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center">
                                <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <span class="font-semibold text-green-400">Complete! Extracted ${success} products</span>
                        </div>
                        <button onclick="exportLastCrawled()" class="px-5 py-2.5 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-colors flex items-center gap-2 cursor-pointer">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            Download CSV (${success})
                        </button>
                    </div>
                `;
                progressLog.parentNode.appendChild(completionDiv);
            }

            await loadProducts();
            lastCrawledSkus = allProducts.slice(0, success).map(p => p.sku);
            showToast(`Extracted ${success}/${csvUrls.length} products from CSV!`);
        }

        let lastCrawledSkus = [];

        function exportLastCrawled() {
            if (lastCrawledSkus.length === 0) { showError('No products to export'); return; }
            const selectedProducts = allProducts.filter(p => lastCrawledSkus.includes(p.sku));
            if (selectedProducts.length === 0) { showError('Products not found'); return; }
            exportProductsToCSV(selectedProducts, `cellphones_crawled_${selectedProducts.length}`);
        }

        function formatPrice(price) { return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(price); }
        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
        function showError(msg) { const errorEl = document.getElementById('errorMsg'); errorEl.textContent = msg; errorEl.classList.remove('hidden'); }
        function showToast(msg) { const toast = document.getElementById('toast'); document.getElementById('toastMsg').textContent = msg; toast.classList.remove('translate-y-full', 'opacity-0'); setTimeout(() => toast.classList.add('translate-y-full', 'opacity-0'), 3000); }

        document.getElementById('productUrl').addEventListener('keypress', function(e) { if (e.key === 'Enter') crawlProduct(); });
        loadProducts();
    </script>
</body>
</html>
